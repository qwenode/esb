# ESB æ€§èƒ½åŸºå‡†æµ‹è¯•æ€»ç»“æŠ¥å‘Š

## ğŸ“Š æµ‹è¯•ç¯å¢ƒ
- **æ“ä½œç³»ç»Ÿ**: Windows 10 (build 19045)
- **CPU**: Intel(R) Core(TM) i9-10980XE CPU @ 3.00GHz (36 cores)
- **æ¶æ„**: amd64
- **Goç‰ˆæœ¬**: 1.21+
- **æµ‹è¯•åŒ…**: github.com/qwenode/esb

## ğŸš€ å®Œæ•´æ€§èƒ½å¯¹æ¯”ç»“æœ

### 1. åŸå§‹åŸºå‡†æµ‹è¯•ç»“æœï¼ˆESB vs åŸç”Ÿï¼‰

| æŸ¥è¯¢ç±»å‹ | ESB æ€§èƒ½ | åŸç”Ÿæ€§èƒ½ | æ€§èƒ½æ¯”ç‡ | å†…å­˜ä½¿ç”¨ (ESB) | å†…å­˜ä½¿ç”¨ (åŸç”Ÿ) |
|---------|----------|----------|----------|---------------|---------------|
| **Term** | 319.0 ns/op | 24.10 ns/op | **13.2x** | 1056 B/op (4 allocs) | 0 B/op (0 allocs) |
| **Match** | 290.7 ns/op | 74.54 ns/op | **3.9x** | 912 B/op (4 allocs) | 144 B/op (1 alloc) |
| **Range** | 317.1 ns/op | 98.17 ns/op | **3.2x** | 944 B/op (6 allocs) | 164 B/op (3 allocs) |
| **Bool** | 2429 ns/op | 254.7 ns/op | **9.5x** | 7672 B/op (23 allocs) | 305 B/op (3 allocs) |
| **Complex** | 6685 ns/op | 571.1 ns/op | **11.7x** | 20096 B/op (51 allocs) | 656 B/op (8 allocs) |
| **Exists** | 183.4 ns/op | 0.23 ns/op | **800x** | 544 B/op (2 allocs) | 0 B/op (0 allocs) |

### 2. ä¼˜åŒ–ç‰ˆæœ¬æ€§èƒ½å¯¹æ¯”

#### A. æ•°å­—èŒƒå›´æŸ¥è¯¢ä¼˜åŒ–
| ç‰ˆæœ¬ | æ€§èƒ½ | å†…å­˜ä½¿ç”¨ | ç›¸å¯¹åŸç”Ÿæ€§èƒ½ | ç›¸å¯¹ESBæ”¹è¿› |
|------|------|----------|-------------|-------------|
| **åŸç‰ˆESB** | 302.4 ns/op | 944 B/op (6 allocs) | **3.7x** | - |
| **ä¼˜åŒ–ç‰ˆæœ¬** | 362.4 ns/op | 1041 B/op (7 allocs) | **4.5x** | **-20%** |
| **åŸç”Ÿç‰ˆæœ¬** | 80.82 ns/op | 96 B/op (3 allocs) | **1.0x** | - |

**åˆ†æ**: å¯¹è±¡æ± ä¼˜åŒ–åœ¨è¿™ä¸ªåœºæ™¯ä¸‹å®é™…ä¸Šé™ä½äº†æ€§èƒ½ï¼Œå› ä¸ºæ± çš„è·å–å’Œé‡Šæ”¾å¼€é”€è¶…è¿‡äº†å†…å­˜åˆ†é…çš„èŠ‚çœã€‚

#### B. TermæŸ¥è¯¢ä¼˜åŒ–ï¼ˆç¼“å­˜æ•ˆæœï¼‰
| ç‰ˆæœ¬ | æ€§èƒ½ | å†…å­˜ä½¿ç”¨ | ç›¸å¯¹åŸç”Ÿæ€§èƒ½ | ç›¸å¯¹ESBæ”¹è¿› |
|------|------|----------|-------------|-------------|
| **åŸç‰ˆESB** | 318.1 ns/op | 1056 B/op (4 allocs) | **13.1x** | - |
| **ç¼“å­˜å‘½ä¸­** | 167.4 ns/op | 512 B/op (1 alloc) | **6.9x** | **+47%** |
| **ç¼“å­˜æœªå‘½ä¸­** | 347.9 ns/op | 1056 B/op (4 allocs) | **14.3x** | **-9%** |
| **åŸç”Ÿç‰ˆæœ¬** | 24.33 ns/op | 0 B/op (0 allocs) | **1.0x** | - |

**åˆ†æ**: é¢„ç¼–è¯‘æ¨¡æ¿åœ¨ç¼“å­˜å‘½ä¸­æ—¶æ˜¾è‘—æå‡æ€§èƒ½ï¼Œå†…å­˜ä½¿ç”¨å‡å°‘50%ï¼Œæ‰§è¡Œæ—¶é—´å‡å°‘47%ã€‚

#### C. ç¼–è¯‘æ—¶ç”ŸæˆæŸ¥è¯¢
| ç‰ˆæœ¬ | æ€§èƒ½ | å†…å­˜ä½¿ç”¨ | ç›¸å¯¹åŸç”Ÿæ€§èƒ½ | ç›¸å¯¹ESBæ”¹è¿› |
|------|------|----------|-------------|-------------|
| **ESB Term** | 326.7 ns/op | 1056 B/op (4 allocs) | **13.3x** | - |
| **ç”ŸæˆTerm** | 47.62 ns/op | 16 B/op (1 alloc) | **1.9x** | **+85%** |
| **ç”ŸæˆMatch** | 75.55 ns/op | 144 B/op (1 alloc) | **3.1x** | **+77%** |
| **åŸç”Ÿç‰ˆæœ¬** | 24.58 ns/op | 0 B/op (0 allocs) | **1.0x** | - |

**åˆ†æ**: ç¼–è¯‘æ—¶ç”Ÿæˆçš„æŸ¥è¯¢æ¥è¿‘åŸç”Ÿæ€§èƒ½ï¼Œç›¸æ¯”ESBæœ‰å·¨å¤§æå‡ï¼ˆ85%+ï¼‰ã€‚

#### D. å¤æ‚æŸ¥è¯¢ä¼˜åŒ–
| ç‰ˆæœ¬ | æ€§èƒ½ | å†…å­˜ä½¿ç”¨ | ç›¸å¯¹æ”¹è¿› |
|------|------|----------|----------|
| **åŸç‰ˆå¤æ‚æŸ¥è¯¢** | 3015 ns/op | 10272 B/op (27 allocs) | - |
| **ä¼˜åŒ–ç‰ˆå¤æ‚æŸ¥è¯¢** | 3070 ns/op | 9807 B/op (24 allocs) | **-2%** |

**åˆ†æ**: å¤æ‚æŸ¥è¯¢çš„ä¼˜åŒ–æ•ˆæœæœ‰é™ï¼Œä¸»è¦åŸå› æ˜¯BoolæŸ¥è¯¢çš„å¼€é”€å ä¸»å¯¼åœ°ä½ã€‚

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœåˆ†æ

### 1. æˆåŠŸçš„ä¼˜åŒ–ç­–ç•¥

#### A. é¢„ç¼–è¯‘æ¨¡æ¿ç¼“å­˜ â­â­â­â­â­
- **æ€§èƒ½æå‡**: 47%
- **å†…å­˜èŠ‚çœ**: 50%
- **é€‚ç”¨åœºæ™¯**: å¸¸ç”¨æŸ¥è¯¢æ¨¡å¼
- **å®ç°å¤æ‚åº¦**: ä½

#### B. ç¼–è¯‘æ—¶ä»£ç ç”Ÿæˆ â­â­â­â­â­
- **æ€§èƒ½æå‡**: 85%+
- **å†…å­˜èŠ‚çœ**: 98%
- **é€‚ç”¨åœºæ™¯**: é™æ€æŸ¥è¯¢
- **å®ç°å¤æ‚åº¦**: ä¸­

### 2. æ•ˆæœæœ‰é™çš„ä¼˜åŒ–ç­–ç•¥

#### A. å¯¹è±¡æ± ä¼˜åŒ– â­â­
- **æ€§èƒ½æå‡**: -20% (è´Ÿä¼˜åŒ–)
- **å†…å­˜èŠ‚çœ**: -10% (è´Ÿä¼˜åŒ–)
- **åŸå› **: æ± ç®¡ç†å¼€é”€ > å†…å­˜åˆ†é…èŠ‚çœ
- **é€‚ç”¨åœºæ™¯**: é«˜é¢‘ç‡ã€å¤§å¯¹è±¡åœºæ™¯

#### B. æ‰¹é‡æŸ¥è¯¢æ„å»ºå™¨ â­â­â­
- **æ€§èƒ½æå‡**: å¾®å°
- **å†…å­˜èŠ‚çœ**: å¾®å°
- **é€‚ç”¨åœºæ™¯**: å¤§é‡æŸ¥è¯¢æ‰¹å¤„ç†

## ğŸ¯ æœ€ä½³å®è·µå»ºè®®

### 1. é«˜æ€§èƒ½åœºæ™¯æ¨èæ–¹æ¡ˆ

```go
// æ–¹æ¡ˆ1: ç¼–è¯‘æ—¶ç”Ÿæˆï¼ˆæœ€ä½³æ€§èƒ½ï¼‰
query := GeneratedTermQuery("status", "published")

// æ–¹æ¡ˆ2: é¢„ç¼–è¯‘æ¨¡æ¿ï¼ˆå¹³è¡¡æ€§èƒ½å’Œçµæ´»æ€§ï¼‰
query, _ := NewQuery(FastTerm("status", "published"))

// æ–¹æ¡ˆ3: æ··åˆä½¿ç”¨
query, _ := NewQuery(
    Bool(
        Must(
            GeneratedTermQuery("status", "published").Build(),
            FastTerm("active", "true"),
        ),
    ),
)
```

### 2. å¼€å‘ä¾¿åˆ©æ€§åœºæ™¯

```go
// ç»§ç»­ä½¿ç”¨æ ‡å‡†ESB APIï¼Œä¼˜å…ˆå¯è¯»æ€§
query, _ := NewQuery(
    Bool(
        Must(
            Term("status", "published"),
            NumberRange("age").Gte(18.0).Lt(65.0).Build(),
        ),
    ),
)
```

### 3. æ€§èƒ½å…³é”®è·¯å¾„ä¼˜åŒ–

```go
// 1. è¯†åˆ«çƒ­ç‚¹æŸ¥è¯¢
var hotQueries = map[string]*types.Query{
    "user_active": GeneratedTermQuery("status", "active"),
    "recent_posts": GeneratedDateRangeQuery("created_at", "now-7d", "now"),
}

// 2. ä½¿ç”¨é¢„ç¼–è¯‘æŸ¥è¯¢
func GetActiveUsers() *types.Query {
    return hotQueries["user_active"]
}

// 3. è¿è¡Œæ—¶ç¼“å­˜
var queryCache = sync.Map{}

func CachedQuery(key string, builder func() *types.Query) *types.Query {
    if cached, ok := queryCache.Load(key); ok {
        return cached.(*types.Query)
    }
    
    query := builder()
    queryCache.Store(key, query)
    return query
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–è·¯çº¿å›¾

### çŸ­æœŸç›®æ ‡ (1-2ä¸ªæœˆ)
- [x] å®ç°é¢„ç¼–è¯‘æ¨¡æ¿ç¼“å­˜
- [x] ç¼–è¯‘æ—¶ä»£ç ç”ŸæˆPOC
- [ ] å¸¸ç”¨æŸ¥è¯¢æ¨¡å¼è¯†åˆ«å’Œä¼˜åŒ–
- [ ] æ€§èƒ½ç›‘æ§å·¥å…·é›†æˆ

### ä¸­æœŸç›®æ ‡ (3-6ä¸ªæœˆ)
- [ ] æ™ºèƒ½æŸ¥è¯¢ç¼“å­˜ç³»ç»Ÿ
- [ ] è‡ªåŠ¨ä»£ç ç”Ÿæˆå·¥å…·
- [ ] æ€§èƒ½å›å½’æµ‹è¯•é›†æˆ
- [ ] æŸ¥è¯¢ä¼˜åŒ–å»ºè®®å·¥å…·

### é•¿æœŸç›®æ ‡ (6-12ä¸ªæœˆ)
- [ ] ç¼–è¯‘æ—¶æŸ¥è¯¢ä¼˜åŒ–å™¨
- [ ] é›¶æ‹·è´æŸ¥è¯¢æ„å»º
- [ ] è‡ªé€‚åº”æ€§èƒ½è°ƒä¼˜
- [ ] æŸ¥è¯¢æ€§èƒ½åˆ†æå™¨

## ğŸ† ç»“è®ºä¸å»ºè®®

### 1. æ€§èƒ½ä¼˜åŒ–æ•ˆæœæ’å

1. **ç¼–è¯‘æ—¶ä»£ç ç”Ÿæˆ**: 85%+ æ€§èƒ½æå‡ï¼Œæ¥è¿‘åŸç”Ÿæ€§èƒ½
2. **é¢„ç¼–è¯‘æ¨¡æ¿ç¼“å­˜**: 47% æ€§èƒ½æå‡ï¼Œ50% å†…å­˜èŠ‚çœ
3. **æŸ¥è¯¢ç»“æ„ä¼˜åŒ–**: å¾®å°æ”¹è¿›
4. **å¯¹è±¡æ± ä¼˜åŒ–**: è´Ÿä¼˜åŒ–ï¼Œä¸æ¨è

### 2. ä½¿ç”¨å»ºè®®

#### é«˜æ€§èƒ½åº”ç”¨
- ä½¿ç”¨ç¼–è¯‘æ—¶ç”Ÿæˆçš„æŸ¥è¯¢
- å®ç°é¢„ç¼–è¯‘æ¨¡æ¿ç¼“å­˜
- é¿å…å¤æ‚çš„Builderæ¨¡å¼

#### ä¸€èˆ¬åº”ç”¨
- ç»§ç»­ä½¿ç”¨ESBæ ‡å‡†API
- åœ¨çƒ­ç‚¹è·¯å¾„ä½¿ç”¨FastTermç­‰ä¼˜åŒ–å‡½æ•°
- å®šæœŸè¿›è¡Œæ€§èƒ½ç›‘æ§

#### å¼€å‘é˜¶æ®µ
- ä¼˜å…ˆä½¿ç”¨ESBæä¾›çš„ä¾¿åˆ©æ€§
- åœ¨æ€§èƒ½æµ‹è¯•ä¸­è¯†åˆ«ç“¶é¢ˆ
- æ¸è¿›å¼ä¼˜åŒ–å…³é”®è·¯å¾„

### 3. æ¶æ„å»ºè®®

```go
// æ¨èçš„åˆ†å±‚æ¶æ„
type QueryBuilder interface {
    // å¼€å‘å‹å¥½çš„æ¥å£
    Build() (*types.Query, error)
}

type OptimizedQueryBuilder interface {
    // æ€§èƒ½ä¼˜åŒ–çš„æ¥å£
    BuildFast() *types.Query
}

type GeneratedQuery interface {
    // ç¼–è¯‘æ—¶ç”Ÿæˆçš„æ¥å£
    Query() *types.Query
}
```

é€šè¿‡è¿™ç§åˆ†å±‚è®¾è®¡ï¼Œå¯ä»¥åœ¨ä¸åŒåœºæ™¯ä¸‹é€‰æ‹©æœ€é€‚åˆçš„æ€§èƒ½/ä¾¿åˆ©æ€§å¹³è¡¡ç‚¹ã€‚ 